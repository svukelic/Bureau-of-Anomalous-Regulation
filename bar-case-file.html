<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BAR Case File</title>
  <link rel="stylesheet" href="bar-style.css">
</head>
<body>
  <div class="container">
    <h1>Bureau of Anomalous Regulation</h1>
    <div class="subtitle">Form A-17 â€“ Anomaly Regulation Case File</div>
    <div class="case-id">CASE ID: BAR-####-[Codename]</div>

    <div class="section two-col">
      <div class="column">
        <label class="label" for="control-code">Control Code-Modifiers</label>
        <input class="input-field" id="control-code" type="text" placeholder="Control code with modifiers" />
      </div>
      <div class="column">
        <label class="label" for="hazard-types">Hazard Types</label>
        <input class="input-field" id="hazard-types" type="text" placeholder="Hazard codes separated by slashes" />
      </div>
    </div>

    <div class="section single-col">
      <label class="label" for="protocol">Protocol</label>
      <input class="input-field" id="protocol" type="text" placeholder="Protocol designation" />
    </div>

    <div class="section three-col">
      <div class="column">
        <label class="label" for="investigator">Lead Investigator</label>
        <input class="input-field" id="investigator" type="text" placeholder="Name / Badge ID" />
      </div>
      <div class="column">
        <label class="label" for="remarks">Remarks</label>
        <input class="input-field" id="remarks" type="text" placeholder="Assignment notes or context" />
      </div>
    </div>

    <div class="section">
      <h3>Containment Protocol</h3>
      <pre id="containment-protocol">[Containment details here]</pre>
    </div>

    <div class="section">
      <h3>Description</h3>
      <pre id="description">[Description of anomaly here]</pre>
    </div>

    <div class="section">
      <h3>Notes & Observations</h3>
      <pre id="notes">[Internal notes, quotes, and insights]</pre>
    </div>

    <div class="section">
      <h3>Discovery Log</h3>
      <pre id="discovery-log">[How it was discovered, cover story, first contact]</pre>
    </div>

    <div class="section">
      <h3>Incident Logs</h3>
      <div id="incident-logs">
        <!-- Incident logs will be dynamically inserted here -->
      </div>
    </div>
  </div>

  <script>
    // Function to extract case ID from URL parameter
    function getCaseIdFromUrl() {
      // Get URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const caseIdParam = urlParams.get('caseId');
      
      // Check if the caseId parameter exists and matches the 4-digit format
      if (caseIdParam && /^\d{4}$/.test(caseIdParam)) {
        return `bar-${caseIdParam}`;
      } else {
        // No valid case ID parameter found
        return null;
      }
    }

    // Function to load JSON data from file
    async function loadCaseData(caseId) {
      try {
        let url;
        if (caseId === 'template') {
          url = 'https://svukelic.github.io/Bureau-of-Anomalous-Regulation/cases/case-template.json';
        } else {
          url = `https://svukelic.github.io/Bureau-of-Anomalous-Regulation/cases/${caseId}.json`;
        }
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Failed to load case data: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        return data;
      } catch (error) {
        console.error(`Error loading ${caseId} data:`, error);
        return null;
      }
    }

    // Function to populate form fields from JSON data
    function populateForm(data) {
      if (!data) return;
      
      // Update page title with case ID
      const caseIdValue = data.caseId.replace(/[\[\]]/g, '');
      document.title = `BAR Case File - ${caseIdValue}`;
      
      // Set case ID in the div
      document.querySelector('.case-id').textContent = `CASE ID: ${caseIdValue}`;
      
      // Set input field values
      document.getElementById('control-code').value = data.controlCode.replace(/[\[\]]/g, '');
      document.getElementById('hazard-types').value = data.hazardTypes.replace(/[\[\]]/g, '');
      document.getElementById('protocol').value = data.protocol.replace(/[\[\]]/g, '');
      document.getElementById('investigator').value = data.investigator.replace(/[\[\]]/g, '');
      document.getElementById('remarks').value = data.remarks.replace(/[\[\]]/g, '');
      
      // Set pre element contents
      document.getElementById('containment-protocol').textContent = data.containmentProtocol.replace(/[\[\]]/g, '');
      document.getElementById('description').textContent = data.description.replace(/[\[\]]/g, '');
      document.getElementById('notes').textContent = data.notes.replace(/[\[\]]/g, '');
      document.getElementById('discovery-log').textContent = data.discoveryLog.replace(/[\[\]]/g, '');
      
      // Handle incident logs
      const incidentLogsContainer = document.getElementById('incident-logs');
      incidentLogsContainer.innerHTML = ''; // Clear existing content
      
      if (data.incidentLogs && data.incidentLogs.length > 0) {
        data.incidentLogs.forEach(incident => {
          const incidentEntry = document.createElement('div');
          incidentEntry.className = 'incident-entry';
          
          const incidentContent = document.createElement('pre');
          const dateText = incident.date.replace(/[\[\]]/g, '');
          const descriptionText = incident.description.replace(/[\[\]]/g, '');
          incidentContent.textContent = `${dateText}: ${descriptionText}`;
          
          incidentEntry.appendChild(incidentContent);
          incidentLogsContainer.appendChild(incidentEntry);
        });
      } else {
        const emptyMessage = document.createElement('pre');
        emptyMessage.textContent = '[No incident logs recorded]';
        incidentLogsContainer.appendChild(emptyMessage);
      }
    }

    // Main function to initialize the page
    async function initPage() {
      const caseId = getCaseIdFromUrl();
      
      if (caseId) {
        // Try to load the case file
        const caseData = await loadCaseData(caseId);
        
        if (caseData) {
          populateForm(caseData);
        } else {
          // If case data couldn't be loaded, try loading the template
          console.log(`Falling back to template for case ${caseId}`);
          const templateData = await loadCaseData('template');
          
          if (templateData) {
            document.title = `BAR Case File - New Case`;
            document.querySelector('.case-id').textContent = `CASE ID: ${caseId} - NEW`;
            populateForm(templateData);
          } else {
            // Display error message if both case data and template couldn't be loaded
            document.title = `BAR Case File - ${caseId} - ERROR`;
            document.querySelector('.case-id').textContent = `CASE ID: ${caseId} - ERROR LOADING DATA`;
          }
        }
      } else {
        // If case ID couldn't be extracted, load the template
        console.log('No case ID found, loading template');
        const templateData = await loadCaseData('template');
        
        if (templateData) {
          document.title = `BAR Case File - Template`;
          document.querySelector('.case-id').textContent = `CASE ID: NEW CASE`;
          populateForm(templateData);
        } else {
          // Display error message if template couldn't be loaded
          document.title = 'BAR Case File - ERROR';
          document.querySelector('.case-id').textContent = 'CASE ID: ERROR LOADING TEMPLATE';
        }
      }
    }

    // Run the initialization when the page is loaded
    document.addEventListener('DOMContentLoaded', initPage);
  </script>
</body>
</html>